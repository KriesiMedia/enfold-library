!function(t){"use strict";t.AviaBuilderGutenberg=function(){this.init=!1,this.aviaBuilder=null,this.body_container=t("body").eq(0),this.body_container.addClass("avia-gutenberg-not-init"),this.metabox=t("#avia_alb_actions"),this.gutenberg_switch_button_source=this.metabox.find(".avia-builder-button"),this.permalink_container=null,this.auto_save_observer=null,this.last_autosave=0,this.minimum_no_autosave=60,"string"==t.avia_builder?this.body_container.on("AviaBuilder_after_set_up",this.set_up.bind(this)):this.set_up()},t.AviaBuilderGutenberg.prototype={set_up:function(){this.aviaBuilder=t.avia_builder,this.aviaBuilder.disable_autoswitch_editor_style=!0,void 0!==this.aviaBuilder.switch_button.length&&this.aviaBuilder.switch_button.length>0&&this.aviaBuilder.switch_button.off("click"),this.aviaBuilder.switch_button=t("#postdivrich_wrap_builder_meta").find(".avia-builder-button"),this.permalink_container=t("#avia_builder #titlediv #edit-slug-box"),this.wait_for_gutenberg_init(),this.attach_handlers()},wait_for_gutenberg_init:function(){var e=this.get_gutenberg_header_settings_container(),i=this;if(0!=e.length){if(this.copy_layout_switch_button(),this.monitor_save_infos(),-1!=navigator.userAgent.indexOf("Firefox")){var a=this.aviaBuilder.switch_button.html();("active"==this.aviaBuilder.activeStatus.val()?this.aviaBuilder.switch_button.data("active-button")!=a:this.aviaBuilder.switch_button.data("inactive-button")!=a)&&(console.log("FF fix executed"),this.aviaBuilder.switch_button.trigger("click"))}if(this.aviaBuilder.body_container.hasClass("avia-force-alb")&&"active"!=this.aviaBuilder.activeStatus.val()&&this.aviaBuilder.switch_button.trigger("click"),this.aviaBuilder.builder_drag_drop_container=t("body.block-editor-page .block-editor #avia_builder").closest(".edit-post-layout__metaboxes"),"active"==this.aviaBuilder.activeStatus.val()){var n=this.aviaBuilder.secureContent.val();this.set_gutenberg_post_content(n);for(var r=0;r<tinymce.editors.length;r++){var s=tinymce.editors[r].id.toLowerCase().trim();tinymce.remove("#"+s)}this.select_document_tab()}this.attach_metabox_toggle_fix(),this.init=!0,this.body_container.removeClass("avia-gutenberg-not-init")}else setTimeout((function(){i.wait_for_gutenberg_init()}),100)},copy_layout_switch_button:function(){var t=this.get_layout_switch_button();if(!1!==t)return t;this.gutenberg_switch_button_source.hide();var e=this.gutenberg_switch_button_source.clone();return this.get_gutenberg_header_settings_container().prepend(e),e.show().attr("id",""),e.on("click",this.switch_layout_mode_gutenberg_btn.bind(this)),e},get_gutenberg_header_settings_container:function(){var e=t(".edit-post-header__settings").first();return e.length||(e=t(".editor-header__settings").first()).addClass("edit-post-header__settings"),e},get_layout_switch_button:function(){var t=this.get_gutenberg_header_settings_container().find(".avia-builder-button").first();return t.length>0&&t},get_gutenberg_save_draft_button:function(){var t=this.get_gutenberg_header_settings_container().find(".editor-post-save-draft").first();return t.length>0&&t},get_gutenberg_publish_button:function(){var t=this.get_gutenberg_header_settings_container().find(".editor-post-publish-button").first();return t.length>0&&t},get_gutenberg_switch_to_draft_button:function(){var t=this.get_gutenberg_header_settings_container().find(".editor-post-switch-to-draft").first();return t.length>0&&t},get_gutenberg_publish_new_post_button:function(){var t=this.get_gutenberg_header_settings_container().find(".editor-post-publish-panel__toggle").first();return t.length>0&&t},get_gutenberg_title:function(){return wp.data.select("core/editor").getEditedPostAttribute("title")},set_gutenberg_title:function(t){t="string"==typeof t?t.trim():"";wp.data.dispatch("core/editor").editPost({title:t})},get_alb_title:function(){var t=this.body_container.find(".avia_meta_box_visual_editor #titlewrap input").first();return t.length>0&&t.val()},set_alb_title:function(t,e){var i=this.body_container.find(".avia_meta_box_visual_editor #titlewrap input").first(),a=this.body_container.find(".avia_meta_box_visual_editor #titlewrap #title-prompt-text");t="string"==typeof t?t.trim():"";i.val(t),a.length>0?""==t.trim()?a.removeClass("screen-reader-text"):a.addClass("screen-reader-text"):""!=t&&void 0!==e&&"focus"==e&&setTimeout((function(){i.trigger("focus")}),300)},can_publish:function(){if(!this.init)return!1;if(!1!==this.get_gutenberg_publish_button())return!0;var t=this.get_gutenberg_publish_new_post_button();return!1!==t&&void 0===t.attr("disabled")},is_new_post:function(){var t=this.get_gutenberg_save_draft_button();return!1===t||(void 0===t.attr("disabled")||!1!==this.get_gutenberg_publish_new_post_button())},attach_gutenberg_title_event_handler:function(){var e=t(".gutenberg__editor .edit-post-visual-editor .editor-post-title__block textarea.editor-post-title__input").first(),i=this;0!=e.length?e.on("keyup",this.gutenberg_title_keyup.bind(this)):setTimeout((function(){i.attach_gutenberg_title_event_handler()}),100)},attach_edit_permalink_event_handler:function(){this.body_container.find(".av-edit-alb-permalink").on("click",this.alb_edit_permalink.bind(this))},attach_alb_permalink_href_handler:function(){this.body_container.find(".avia_meta_box_visual_editor #edit-slug-box #sample-permalink > a").on("click",this.alb_permalink_href_handler.bind(this))},attach_metabox_toggle_fix:function(){this.body_container.hasClass("block-editor-page")&&this.body_container.hasClass("avia-advanced-editor-enabled")&&this.body_container.find(".postbox-header .handlediv").on("click",this.metabox_toggle_fix)},attach_handlers:function(){var t=this;this.body_container.on("AviaBuilder_after_switch_layout_mode",this.layout_mode_changed.bind(this)),this.body_container.find(".avia_meta_box_visual_editor #titlewrap input").on("keyup",this.alb_title_key_up.bind(this)),this.attach_gutenberg_title_event_handler(),this.aviaBuilder.secureContent.on("av_secureContent_update change",this.alb_secureContent_changed.bind(this));var e=this.aviaBuilder;e.switch_button.on("click",(function(t){t.preventDefault(),e.switch_layout_mode(t)})),this.attach_edit_permalink_event_handler(),this.attach_alb_permalink_href_handler(),setTimeout((function(){t.attach_alb_sticky_element_tab_handler()}),500)},switch_layout_mode_gutenberg_btn:function(t){if(t.preventDefault(),"active"!=this.aviaBuilder.activeStatus.val()){if(!this.set_alb_secure_content())return;for(var e=0;e<tinymce.editors.length;e++){var i=tinymce.editors[e].id.toLowerCase().trim();"content"==i&&e!=tinymce.editors.length-1&&tinymce.remove("#"+i)}this.set_alb_title(this.get_gutenberg_title(),"focus"),this.body_container.removeClass("avia-edit-permalink"),this.alb_sync_permalink(),this.select_document_tab()}else{this.set_gutenberg_title(this.get_alb_title());var a=this.aviaBuilder.secureContent.val();this.set_gutenberg_post_content(a)}this.aviaBuilder.switch_button.trigger("click")},select_document_tab:function(){var t=this.body_container.find(".edit-post-sidebar .components-panel__header button.edit-post-sidebar__panel-tab").eq(0);t.hasClass("is-active")||t.trigger("click")},attach_alb_sticky_element_tab_handler:function(){var e=t("#avia_builder");document.querySelector(".interface-interface-skeleton__content").addEventListener("scroll",(function(i){var a,n,r=t(this).scrollTop();a=function(){r>110?e.addClass("avia-sticky-fixed-controls"):e.removeClass("avia-sticky-fixed-controls")},clearTimeout(a._tId),a._tId=setTimeout((function(){a()}),n)}))},alb_edit_permalink:function(t){t.preventDefault(),this.body_container.addClass("avia-edit-permalink"),this.get_layout_switch_button().trigger("click")},alb_sync_permalink:function(){var t=wp.data.select("core/editor").getPermalink(),e=wp.data.select("core/editor").getCurrentPost(),i=e.link;i+=-1==i.indexOf("?")?"?preview=true":"&preview=true";var a="wp-preview-"+e.id,n=this.permalink_container.find("#sample-permalink > a").first();if(n.length>0)n.attr("href",i).attr("target",a),n.html(t);else{var r="<strong>Permalink:</strong>";r+='<span id="sample-permalink">',r+='<a href="'+i+'" target="'+a+'">'+t+"</a>",r+="</span>",r+='<span id="av-edit-alb-permalink-buttons">',r+='<button type="button" class="av-edit-alb-permalink button button-small hide-if-no-js" aria-label="Edit permalink">Edit</button>',r+="</span>",this.permalink_container.html(r),this.attach_edit_permalink_event_handler(),this.attach_alb_permalink_href_handler()}},alb_permalink_href_handler:function(t){this.alb_sync_permalink()},metabox_toggle_fix:function(e){var i,a=t(this),n=a.closest(".postbox");n.toggleClass("closed"),i=!n.hasClass("closed"),a.attr("aria-expanded",i)},layout_mode_changed:function(t,e,i){t.preventDefault();var a=this.get_layout_switch_button();!1!==a&&a.text(e.text),this.gutenberg_switch_button_source.text(e.text)},alb_secureContent_changed:function(t,e){if(!e){var i=this.aviaBuilder.secureContent.val();"string"==typeof t&&"title"==t&&""==i.trim()||this.set_gutenberg_post_content(i),this.select_document_tab()}},gutenberg_title_keyup:function(t){var e=this.get_gutenberg_title();this.set_alb_title(e)},alb_title_key_up:function(e){var i=e.target,a=t(i).val();this.set_gutenberg_title(a),this.alb_secureContent_changed("title")},set_gutenberg_post_content:function(e){e=e.trim();var i=wp.data.dispatch("core/block-editor"),a=wp.data.select("core/block-editor").getBlocks(),n=null;if(a.length>0&&t.each(a,(function(t,a){"core/shortcode"==a.name&&e.length>0&&null==n?n=a:i.removeBlock(a.clientId)})),null==n){var r=wp.blocks.createBlock("core/shortcode",{text:e});i.insertBlocks(r)}else i.updateBlockAttributes(n.clientId,{text:e})},set_alb_secure_content:function(){var e=this.aviaBuilder.secureContent.val();if(this.aviaBuilder.canvas.children().remove(),""!=e.trim())return!0;var i=wp.data.select("core/block-editor").getBlocks(),a=[],n=0;if(t.each(i,(function(t,e){var i="";void 0!==e.attributes.content?i=e.attributes.content:void 0!==e.attributes.text?i=e.attributes.text:n++,""!=i&&a.push(i)})),0==n&&0==a.length)return!0;if(n>0&&!window.confirm(avia_gutenberg_i18.switch_block_msg))return!1;var r=a.join("\n\n"),s=!!this.aviaBuilder.tiny_active&&window.tinyMCE.get("content");if(s){var o=a.join("<br /><br />");s.setContent(o,{format:"html"})}return this.aviaBuilder.secureContent.val(r),this.aviaBuilder.classic_textarea.val(r),!0},monitor_save_infos:function(){if(null==this.auto_save_observer){var t=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,e=this.get_gutenberg_header_settings_container()[0];this.auto_save_observer=new t(this.check_for_is_saving.bind(this)),this.auto_save_observer.observe(e,{childList:!0,subtree:!0})}},check_for_is_saving:function(e){var i=this;t.each(e,(function(e,a){if(void 0!==a.type&&("childList"==a.type||"subtree"==a.type))for(var n=0;n<a.addedNodes.length;n++){var r=t(a.addedNodes[n]);if(r.hasClass("editor-post-saved-state")&&r.hasClass("is-saving")){if(i.body_container.hasClass("post-type-portfolio")){var s=i.body_container.find("#wp-_preview_text-wrap").first();if(s.length>0&&s.hasClass("tmce-active")){var o=s.find("#_preview_text"),_=o.val();window.tinyMCE.get("_preview_text")&&(_=window.tinyMCE.get("_preview_text").getContent()),o.val(_)}}r.hasClass("is-autosaving")&&i.alb_perform_autosave(i)}}}))},alb_perform_autosave:function(e){if(!(0!=this.last_autosave&&this.last_autosave+1e3*this.minimum_no_autosave>Date.now())){this.last_autosave=Date.now();var i={action:"avia_gutenberg_autosave_metaboxes",post_id:wp.data.select("core/editor").getCurrentPost().id},a=t("form.metabox-location-normal, form.metabox-location-side").serializeArray();t.each(a,(function(t,e){i[e.name]=e.value})),t.ajax({type:"POST",url:ajaxurl,dataType:"json",cache:!1,data:i,success:function(t,i,a){void 0!==t.avia_gutenberg_nonce&&e.body_container.find('#avia_builder input[name="avia_gutenberg_nonce"]').val(t.avia_gutenberg_nonce),t.success||void 0===t.expired_nonce||e.alb_perform_autosave(e)},error:function(t){},complete:function(t){}})}}},t((function(){t("body").hasClass("block-editor-page")&&(t.avia_builder_gutenberg=new t.AviaBuilderGutenberg)}))}(jQuery);